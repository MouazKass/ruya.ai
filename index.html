<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pandemic Command Center v5</title>
    
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>

    <style>
        /* --- CSS VARIABLES --- */
        :root {
            --bg-color: #f0f2f5;
            --map-sea-color: #dbeafe;
            --country-fill: #cbd5e1;
            --country-stroke: #ffffff;
            --country-hover: #94a3b8;
            --country-active: #475569;
            
            --text-main: #1e293b;
            --text-secondary: #64748b;
            
            --panel-bg: rgba(255, 255, 255, 0.9);
            --panel-border: 1px solid rgba(255, 255, 255, 0.6);
            --panel-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            
            --city-fill: #ffc107;
            --city-stroke: #ffffff;
            --city-hover: #ff9800;
            
            --accent-color: #2563eb;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --success-color: #10b981;
            
            --card-bg: rgba(255,255,255,0.5);
            --ai-pulse: #2563eb;

            /* Route Colors */
            --flight-color: #dc2626; 
            --ship-color: #0284c7;   
        }

        [data-theme="night"] {
            --bg-color: #0f172a;
            --map-sea-color: #0f172a;
            --country-fill: #1e293b;
            --country-stroke: #334155;
            --country-hover: #334155;
            --country-active: #475569;
            
            --text-main: #f8fafc;
            --text-secondary: #94a3b8;
            
            --panel-bg: rgba(15, 23, 42, 0.9);
            --panel-border: 1px solid rgba(255, 255, 255, 0.1);
            --panel-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            
            --city-fill: #ffd54f;
            --city-stroke: #1e293b;
            --city-hover: #ffecb3;
            
            --accent-color: #60a5fa;
            --card-bg: rgba(255,255,255,0.05);
            --ai-pulse: #60a5fa;
            
            --flight-color: #f87171;
            --ship-color: #38bdf8;
        }

        /* --- LAYOUT --- */
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', Roboto, sans-serif; background-color: var(--map-sea-color); color: var(--text-main); transition: background 0.5s; }
        #container { position: relative; width: 100vw; height: 100vh; }

        /* --- MAP & CURSOR --- */
        #map-wrapper { width: 100%; height: 100%; cursor: default; }
        svg { display: block; width: 100%; height: 100%; }

        /* --- LEFT SIDEBAR --- */
        #left-sidebar {
            position: absolute; top: 20px; left: 20px; bottom: 160px;
            width: 320px;
            display: flex; flex-direction: column; gap: 15px;
            pointer-events: none;
        }

        .glass-panel {
            background-color: var(--panel-bg);
            border: var(--panel-border);
            backdrop-filter: blur(12px);
            border-radius: 12px;
            box-shadow: var(--panel-shadow);
            pointer-events: auto;
            padding: 15px;
            transition: all 0.3s ease;
        }

        /* 1. STATUS PANEL */
        #status-panel { cursor: pointer; border-left: 6px solid var(--success-color); }
        #status-panel:hover { transform: scale(1.02); }
        .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .panel-title { font-weight: 700; font-size: 0.8rem; text-transform: uppercase; color: var(--text-secondary); letter-spacing: 1px; }
        .status-main { font-size: 2rem; font-weight: 700; color: var(--text-main); line-height: 1; }
        .status-sub { font-size: 0.9rem; font-weight: 600; margin-top: 4px; color: var(--success-color); transition: color 0.3s; }
        
        /* 2. AI ALERTS LIST */
        #rec-list { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        #rec-list::-webkit-scrollbar { width: 4px; }
        #rec-list::-webkit-scrollbar-thumb { background: var(--text-secondary); border-radius: 4px; }
        
        /* AI Pulse Animation */
        .ai-indicator {
            width: 8px; height: 8px; background-color: var(--ai-pulse);
            border-radius: 50%; display: inline-block; margin-right: 8px;
            box-shadow: 0 0 0 rgba(37, 99, 235, 0.4);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.7); }
            70% { box-shadow: 0 0 0 6px rgba(37, 99, 235, 0); }
            100% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0); }
        }

        .rec-item { background: var(--card-bg); padding: 10px; border-radius: 8px; border-left: 3px solid var(--text-secondary); font-size: 0.9rem; animation: fadeIn 0.3s ease; }
        .rec-head { font-weight: 600; margin-bottom: 4px; display:flex; justify-content:space-between; font-size: 0.85rem;}
        .rec-body { font-size: 0.8rem; color: var(--text-secondary); line-height: 1.4; }

        /* 3. ACTION CARDS */
        #action-list { display: flex; flex-direction: column; gap: 10px; min-height: 180px; }
        .action-card { 
            background: var(--card-bg); padding: 12px; border-radius: 8px; 
            display: flex; align-items: center; gap: 12px; cursor: pointer; 
            transition: all 0.2s; border: 1px solid transparent; animation: slideIn 0.3s ease;
        }
        .action-card:hover { background: rgba(128,128,128,0.1); border-color: var(--accent-color); transform: translateX(5px); }
        .action-icon { font-size: 1.2rem; }
        .action-text { font-weight: 600; font-size: 0.9rem; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { transform: translateX(-10px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* --- MODAL --- */
        #status-modal {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9);
            width: 65%; height: 70%; background: var(--panel-bg); border: var(--panel-border);
            backdrop-filter: blur(25px); border-radius: 16px; z-index: 100;
            opacity: 0; pointer-events: none; transition: all 0.3s ease;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4); display: flex; flex-direction: column; padding: 30px;
        }
        #status-modal.visible { opacity: 1; pointer-events: auto; transform: translate(-50%, -50%) scale(1); }
        .modal-close { position: absolute; top: 20px; right: 20px; font-size: 1.5rem; cursor: pointer; color: var(--text-secondary); }
        .modal-grid { display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: auto 1fr; gap: 20px; margin-top: 20px; height: 100%; overflow-y: auto; }
        .info-card { background: rgba(128,128,128,0.05); padding: 20px; border-radius: 12px; border: 1px solid rgba(128,128,128,0.1); }
        .symptom-row { display: flex; align-items: center; margin-bottom: 8px; font-size: 0.9rem; }
        .sym-bar-bg { flex: 1; height: 8px; background: rgba(128,128,128,0.2); border-radius: 4px; overflow: hidden; margin: 0 10px;}
        .sym-bar-fill { height: 100%; background: var(--danger-color); }
        .risk-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(128,128,128,0.1); font-size: 0.9rem; }

        /* --- BOTTOM & CONTROLS --- */
        #controls-area { position: absolute; bottom: 160px; right: 30px; display: flex; flex-direction: column; gap: 10px; z-index: 20; }
        .icon-btn { width: 44px; height: 44px; border-radius: 50%; border: var(--panel-border); background-color: var(--panel-bg); color: var(--text-main); box-shadow: var(--panel-shadow); display: flex; align-items: center; justify-content: center; font-size: 1.2rem; cursor: pointer; transition: transform 0.2s; }
        .icon-btn:hover { transform: scale(1.1); }

        #bottom-panel { position: absolute; bottom: 20px; left: 20px; right: 20px; height: 120px; background-color: var(--panel-bg); border: var(--panel-border); backdrop-filter: blur(12px); border-radius: 16px; box-shadow: var(--panel-shadow); z-index: 10; display: flex; align-items: center; padding: 0 30px; gap: 30px; }
        .country-header { min-width: 220px; border-right: 1px solid var(--text-secondary); padding-right: 20px; }
        .country-header h2 { margin: 0; font-size: 1.8rem; color: var(--accent-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .country-header p { margin: 5px 0 0 0; color: var(--text-secondary); font-size: 0.9rem; }
        .stats-container { display: flex; flex: 1; justify-content: space-around; }
        .stat-item { display: flex; flex-direction: column; gap: 4px; }
        .stat-label { font-size: 0.75rem; text-transform: uppercase; color: var(--text-secondary); letter-spacing: 1px; font-weight: 600; }
        .stat-value { font-size: 1.3rem; font-weight: 600; color: var(--text-main); }
        
        #news-action { width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: var(--text-secondary); border-left: 1px solid var(--text-secondary); padding-left: 30px; opacity: 0; pointer-events: none; transition: all 0.3s; cursor: pointer; }
        #news-action.visible { opacity: 1; pointer-events: auto; }
        #news-action:hover { color: var(--accent-color); transform: scale(1.1); }

        /* Map Styles */
        #tooltip { position: absolute; opacity: 0; background: rgba(0, 0, 0, 0.9); color: #fff; padding: 6px 12px; border-radius: 4px; font-size: 0.8rem; pointer-events: none; transform: translate(-50%, -150%); transition: opacity 0.1s; z-index: 200; white-space: nowrap; }
        .country { fill: var(--country-fill); stroke: var(--country-stroke); stroke-width: 0.5px; transition: fill 0.2s; }
        .country:hover { fill: var(--country-hover); cursor: pointer; }
        .country.active { fill: var(--country-active); }
        .city-marker { fill: var(--city-fill); stroke: var(--city-stroke); stroke-width: 1.5px; transition: r 0.2s; cursor: pointer; }
        .city-marker:hover { fill: var(--city-hover); }

        /* --- VECTOR LINES (Animation) --- */
        .route-line { fill: none; stroke-linecap: round; opacity: 0.4; pointer-events: none; }
        
        .flight-path { 
            stroke: var(--flight-color); 
            stroke-width: 1px; 
            stroke-dasharray: 2, 4;
        }
        
        .ship-path { 
            stroke: var(--ship-color); 
            stroke-width: 1.5px; 
        }

        .vehicle-icon { pointer-events: none; }
        .port-icon { fill: var(--ship-color); pointer-events: none; opacity: 0.8; }

    </style>
</head>
<body>

<div id="container">

    <div id="left-sidebar">
        <div id="status-panel" class="glass-panel" title="Click for Detailed Disease Report">
            <div class="panel-header">
                <span class="panel-title">Active Cases</span>
                <span style="font-size: 1.2rem;">‚§¢</span>
            </div>
            <div class="status-main" id="status-count">---</div>
            <div class="status-sub" id="status-label">Global Aggregate</div>
        </div>

        <div id="rec-list" class="glass-panel">
            <div class="panel-header" style="justify-content: flex-start; margin-bottom: 12px;">
                <span class="ai-indicator"></span>
                <span class="panel-title">Live AI Analysis</span>
            </div>
            <div id="alerts-container">
                </div>
        </div>

        <div id="action-list" class="glass-panel">
            <div class="panel-title" style="margin-bottom:5px;">Recommended Actions</div>
            <div id="actions-container">
                </div>
        </div>
    </div>

    <div id="status-modal">
        <div class="modal-close" id="close-modal">√ó</div>
        <div style="border-bottom: 1px solid var(--text-secondary); padding-bottom: 15px; margin-bottom:10px;">
            <h1 style="margin:0; font-size:1.8rem;">Pathogen Analysis Report</h1>
            <span id="modal-region-name" style="color:var(--accent-color); font-weight:600;">Global View</span>
        </div>
        <div class="modal-grid">
            <div class="info-card">
                <h3>Reported Symptoms</h3>
                <div id="symptom-list"></div>
            </div>
            <div class="info-card">
                <h3>Regional Transmission Risks</h3>
                <div style="margin-bottom:10px; font-size:0.8rem; color:var(--text-secondary);">Top Vectors by Volume:</div>
                <div id="neighbor-list"></div>
            </div>
            <div class="info-card" style="grid-column: span 2; display:flex; justify-content:space-around; align-items:center;">
                <div style="text-align:center;">
                    <div style="font-size:0.8rem; color:var(--text-secondary); text-transform:uppercase;">Transmission (R0)</div>
                    <div style="font-size:2.5rem; font-weight:700; color:var(--warning-color);" id="metric-r0">--</div>
                </div>
                <div style="width:1px; height:50px; background:rgba(128,128,128,0.3);"></div>
                <div style="text-align:center;">
                    <div style="font-size:0.8rem; color:var(--text-secondary); text-transform:uppercase;">Fatality Rate</div>
                    <div style="font-size:2.5rem; font-weight:700; color:var(--danger-color);" id="metric-cfr">--%</div>
                </div>
                <div style="width:1px; height:50px; background:rgba(128,128,128,0.3);"></div>
                 <div style="text-align:center;">
                    <div style="font-size:0.8rem; color:var(--text-secondary); text-transform:uppercase;">Healthcare Load</div>
                    <div style="font-size:2.5rem; font-weight:700; color:var(--accent-color);" id="metric-load">--%</div>
                </div>
            </div>
        </div>
    </div>

    <div id="controls-area">
        <div id="btn-theme" class="icon-btn"><span id="theme-icon">‚òæ</span></div>
        <div id="btn-reset" class="icon-btn"><span>‚ü≤</span></div>
    </div>

    <div id="bottom-panel">
        <div class="country-header">
            <h2 id="dash-name">Select Location</h2>
            <p id="dash-sub">Global View</p>
        </div>
        <div class="stats-container">
            <div class="stat-item"><span class="stat-label" id="lbl-1">Population</span><span class="stat-value" id="val-1">---</span></div>
            <div class="stat-item"><span class="stat-label" id="lbl-2">GDP (USD)</span><span class="stat-value" id="val-2">---</span></div>
            <div class="stat-item"><span class="stat-label" id="lbl-3">Active Cases</span><span class="stat-value" id="val-3">---</span></div>
            <div class="stat-item"><span class="stat-label" id="lbl-4">Risk Level</span><span class="stat-value" id="val-4">---</span></div>
        </div>
        <div id="news-action" title="View News Reports">üì∞</div>
    </div>

    <div id="map-wrapper"></div>
    <div id="tooltip"></div>

</div>

<script>
// --- 1. DATA INFRASTRUCTURE ---
const config = { 
    mapUrl: "https://unpkg.com/world-atlas@2.0.2/countries-110m.json",
    statsUrl: "stats.json" // Path to your new data file
};

// The DB object now starts empty and is populated by the fetch request
let DB = {
    countries: {},
    cities: [],
    features: {}, 
    global: { pop: 0, infected: 0, gdp: 0 },
    
    // Processes the JSON data and calculates global aggregates
    init: function(data) {
        this.countries = data.countries;
        this.cities = data.cities;
        
        // Reset totals before calculation
        this.global = { pop: 0, infected: 0, gdp: 0 };
        
        Object.keys(this.countries).forEach(id => {
            const c = this.countries[id];
            this.global.pop += c.pop;
            this.global.infected += c.infected;
            this.global.gdp += c.gdp;
        });
    },
    get: function(id) { return this.countries[id] || null; }
};

// --- 2. AI INSIGHT LOGIC ---
const AI_INSIGHTS = {
    LOW: [
        { alert: "Social sentiment normal.", type: "Observation", color: "var(--success-color)", action: "Maintain Monitoring", icon: "üîç" },
        { alert: "Hygiene adherence at 78%.", type: "Opportunity", color: "var(--success-color)", action: "Public Info Campaign", icon: "üì¢" }
    ],
    MEDIUM: [
        { alert: "Abnormal travel vectors detected.", type: "Warning", color: "var(--warning-color)", action: "Screen Incoming Arrivals", icon: "üå°Ô∏è" },
        { alert: "PPE reserves depleting rapidly.", type: "Logistics", color: "var(--warning-color)", action: "Distribute Stockpile", icon: "üì¶" }
    ],
    HIGH: [
        { alert: "Healthcare capacity critical.", type: "CRITICAL", color: "var(--danger-color)", action: "Deploy Field Hospitals", icon: "üè•" },
        { alert: "Viral mutation markers found.", type: "Bio-Threat", color: "var(--danger-color)", action: "Enforce Regional Lockdown", icon: "üöß" },
        { alert: "Uncontrolled border transmission.", type: "Security", color: "var(--danger-color)", action: "Seal National Borders", icon: "‚õî" }
    ]
};

function determineStatus(infected, pop) {
    const rate = infected / pop;
    if (rate > 0.02) return { level: "CRITICAL", color: "var(--danger-color)", protocols: AI_INSIGHTS.HIGH };
    if (rate > 0.005) return { level: "ELEVATED", color: "var(--warning-color)", protocols: AI_INSIGHTS.MEDIUM };
    return { level: "STABLE", color: "var(--success-color)", protocols: AI_INSIGHTS.LOW };
}

// --- 3. D3 & RENDER LOGIC ---
let width = window.innerWidth, height = window.innerHeight;
let activeCountry = d3.select(null);
let isNightMode = false;

const svg = d3.select("#map-wrapper").append("svg").attr("viewBox", [0, 0, width, height]).on("click", resetView);
const defs = svg.append("defs");

// Plane Icon Path
defs.append("path").attr("id", "plane-icon")
    .attr("d", "M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z")
    .attr("transform", "scale(0.8) rotate(90 12 12) translate(-12 -12)");

const g = svg.append("g"); 
const routesLayer = svg.append("g"); 

const projection = d3.geoNaturalEarth1().translate([width / 2, height / 2]);
const path = d3.geoPath().projection(projection);

const zoom = d3.zoom().scaleExtent([1, 12]).on("zoom", (e) => {
    g.attr("transform", e.transform);
    routesLayer.attr("transform", e.transform);
    g.selectAll("path.country").attr("stroke-width", 0.5 / e.transform.k);
    g.selectAll(".city-marker").attr("r", 5 / Math.sqrt(e.transform.k));
    routesLayer.selectAll("path.route-line").attr("stroke-width", 1 / e.transform.k);
});
svg.call(zoom);
const tooltip = d3.select("#tooltip");

// LOADING SEQUENCE
Promise.all([
    d3.json(config.mapUrl),
    d3.json(config.statsUrl)
]).then(([worldData, statsData]) => {
    
    // 1. Initialize DB with the external JSON
    DB.init(statsData);

    // 2. Process Map Data
    const countries = topojson.feature(worldData, worldData.objects.countries).features;
    countries.forEach(c => { DB.features[c.id] = c; });

    projection.fitSize([width, height], topojson.feature(worldData, worldData.objects.countries));
    
    // 3. Render Countries
    g.selectAll("path").data(countries)
        .enter().append("path").attr("d", path).attr("class", "country")
        .on("click", clickedCountry)
        .on("mouseover", (e, d) => {
            const country = DB.get(d.id);
            showTooltip(e, country ? country.name : "Territory");
        })
        .on("mouseout", hideTooltip);

    // 4. Render Cities (using cities array from JSON)
    g.selectAll(".city-marker").data(DB.cities)
        .enter().append("circle").attr("class", "city-marker")
        .attr("cx", d => projection(d.coords)[0]).attr("cy", d => projection(d.coords)[1]).attr("r", 4)
        .on("click", clickedCity)
        .on("mouseover", (e, d) => showTooltip(e, d.name))
        .on("mouseout", hideTooltip);
    
    // 5. Set Initial Global View
    updateView('global', null);

}).catch(error => {
    console.error("Error loading Pandemic Command Center data:", error);
});

// --- INTERACTION ---

function clickedCountry(event, d) {
    event.stopPropagation();
    activeCountry.classed("active", false);
    activeCountry = d3.select(this).classed("active", true);
    updateView('country', d.id);
    drawConnections(d.id); 
}

function clickedCity(event, d) {
    event.stopPropagation();
    activeCountry.classed("active", false);
    updateView('city', d);
    drawConnections(d.countryId);
}

function resetView() {
    activeCountry.classed("active", false);
    updateView('global', null);
    routesLayer.selectAll("*").remove(); 
}

function drawConnections(sourceId) {
    routesLayer.selectAll("*").remove(); 
    const sourceFeature = DB.features[sourceId];
    if(!sourceFeature) return;

    const sourceCentroid = d3.geoCentroid(sourceFeature);
    // Filter out destinations that don't exist in our JSON list
    const targetIds = Object.keys(DB.countries).filter(id => id !== sourceId);
    
    const flightTargets = [];
    const shipTargets = [];
    
    for(let i=0; i < Math.min(4, targetIds.length); i++) {
        const rid = targetIds[Math.floor(Math.random()*targetIds.length)];
        if(DB.features[rid]) flightTargets.push(DB.features[rid]);
    }
    for(let i=0; i < Math.min(3, targetIds.length); i++) {
        const rid = targetIds[Math.floor(Math.random()*targetIds.length)];
        if(DB.features[rid]) shipTargets.push(DB.features[rid]);
    }

    flightTargets.forEach(target => {
        const geoPath = {type: "LineString", coordinates: [sourceCentroid, d3.geoCentroid(target)]};
        const pathNode = routesLayer.append("path").datum(geoPath).attr("class", "route-line flight-path").attr("d", path);
        animateVehicle(pathNode, "plane-icon", "var(--flight-color)", 2500);
    });

    shipTargets.forEach(target => {
        const [portX, portY] = projection(sourceCentroid);
        routesLayer.append("text").attr("x", portX).attr("y", portY).attr("class", "port-icon").attr("text-anchor", "middle").attr("dy", ".35em").style("font-size", "14px").text("‚öì");

        const geoPath = {type: "LineString", coordinates: [sourceCentroid, d3.geoCentroid(target)]};
        const pathNode = routesLayer.append("path").datum(geoPath).attr("class", "route-line ship-path").attr("d", path);
        animateVehicle(pathNode, "ship-icon", "var(--ship-color)", 6000);
    });
}

function animateVehicle(pathSelection, iconId, color, duration) {
    const pathEl = pathSelection.node();
    const vehicle = routesLayer.append("g");
    
    if (iconId === 'plane-icon') {
        vehicle.append("path")
            .attr("d", "M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z")
            .attr("fill", color)
            .attr("transform", "scale(0.8) rotate(90 12 12) translate(-12 -12)");
    } else {
         vehicle.append("path")
            .attr("d", "M-10 0 L10 0 L7 6 L-7 6 Z M-3 0 L-3 -6 L3 -6 L3 0")
            .attr("fill", color)
            .attr("transform", "scale(0.8)");
    }

    transition();
    function transition() {
        vehicle.transition().duration(duration).ease(d3.easeLinear).attrTween("transform", translateAlong(pathEl)).on("end", transition);
    }

    function translateAlong(path) {
        const l = path.getTotalLength();
        return function(d, i, a) {
            return function(t) {
                const p = path.getPointAtLength(t * l);
                const pBefore = path.getPointAtLength(Math.max(0, t * l - 1));
                const angle = Math.atan2(p.y - pBefore.y, p.x - pBefore.x) * 180 / Math.PI;
                return "translate(" + p.x + "," + p.y + ") rotate(" + angle + ")";
            };
        };
    }
}

function updateView(type, data) {
    let stats = {};
    let name = "", sub = "";

    if (type === 'global') {
        stats = DB.global;
        name = "Select Location"; sub = "Global Aggregate View";
        document.getElementById("news-action").classList.remove("visible");
    } 
    else if (type === 'country') {
        const cData = DB.get(data);
        if (!cData) { stats = { pop: 0, infected: 0, gdp: 0 }; name = "Unknown Territory"; } 
        else { stats = cData; name = cData.name; }
        sub = "Nation Status";
        document.getElementById("news-action").classList.add("visible");
    } 
    else if (type === 'city') {
        const country = DB.get(data.countryId) || { infected: 0, pop: 1 };
        const infectionRate = country.infected / country.pop;
        stats = { pop: data.pop, infected: Math.floor(data.pop * infectionRate * 1.2), gdp: 0 };
        name = data.name; sub = "Major Urban Center";
        document.getElementById("news-action").classList.add("visible");
    }

    const status = determineStatus(stats.infected, stats.pop);
    updateSidebar(stats.infected, status);

    animateText("dash-name", name);
    animateText("dash-sub", sub);
    animateText("val-1", formatNum(stats.pop));
    animateText("val-2", stats.gdp === 0 ? "---" : "$" + stats.gdp + " B");
    animateText("val-3", formatNum(stats.infected));
    document.getElementById("val-4").style.color = status.color;
    animateText("val-4", status.level);
}

function updateSidebar(infectedCount, statusData) {
    const panel = document.getElementById("status-panel");
    panel.style.borderLeftColor = statusData.color;
    animateText("status-count", formatNum(infectedCount));
    document.getElementById("status-label").innerText = statusData.level + " CONDITION";
    document.getElementById("status-label").style.color = statusData.color;

    const alertsContainer = document.getElementById("alerts-container");
    const actionsContainer = document.getElementById("actions-container");
    let alertsHTML = "", actionsHTML = "";

    statusData.protocols.forEach(item => {
        alertsHTML += `
            <div class="rec-item" style="border-left-color:${item.color}">
                <div class="rec-head">
                    <span>${item.type}</span>
                    <span style="color:${item.color}">‚óè</span>
                </div>
                <div class="rec-body">"${item.alert}"</div>
            </div>`;
        
        actionsHTML += `
            <div class="action-card">
                <span class="action-icon">${item.icon}</span>
                <span class="action-text">${item.action}</span>
            </div>`;
    });
    alertsContainer.innerHTML = alertsHTML;
    actionsContainer.innerHTML = actionsHTML;
}

document.getElementById("status-panel").addEventListener("click", () => {
    document.getElementById("status-modal").classList.add("visible");
    populateModal();
});
document.getElementById("close-modal").addEventListener("click", () => document.getElementById("status-modal").classList.remove("visible"));

function populateModal() {
    const title = document.getElementById("dash-name").innerText;
    document.getElementById("modal-region-name").innerText = title;
    document.getElementById("metric-r0").innerText = (1.2 + Math.random()).toFixed(2);
    document.getElementById("metric-cfr").innerText = (2 + Math.random()*3).toFixed(1) + "%";
    document.getElementById("metric-load").innerText = Math.floor(60 + Math.random()*35) + "%";
    document.getElementById("symptom-list").innerHTML = `
        <div class="symptom-row"><div style="width:100px;">Fever</div><div class="sym-bar-bg"><div class="sym-bar-fill" style="width:88%"></div></div><div>88%</div></div>
        <div class="symptom-row"><div style="width:100px;">Cough</div><div class="sym-bar-bg"><div class="sym-bar-fill" style="width:65%"></div></div><div>65%</div></div>
    `;
    const keys = Object.keys(DB.countries);
    let nHtml = "";
    for(let i=0; i<3; i++) {
        let c = DB.countries[keys[Math.floor(Math.random()*keys.length)]];
        if(c) nHtml += `<div class="risk-item"><span>${c.name}</span><span style="color:var(--danger-color)">${formatNum(c.infected)} cases</span></div>`;
    }
    document.getElementById("neighbor-list").innerHTML = nHtml;
}

function showTooltip(e, t) { 
    let x = e.pageX; if(x > window.innerWidth-120) x -= 120;
    tooltip.style("opacity",1).text(t).style("left",x+"px").style("top",(e.pageY-10)+"px"); 
}
function hideTooltip() { tooltip.style("opacity",0); }
function formatNum(n) { 
    if(n >= 1000000) return (n/1000000).toFixed(1) + "M";
    if(n >= 1000) return (n/1000).toFixed(1) + "k";
    return n; 
}
function animateText(id, txt) { 
    const el = document.getElementById(id); el.style.opacity=0; 
    setTimeout(()=>{ el.innerText=txt; el.style.opacity=1; }, 150); 
}

document.getElementById("btn-theme").addEventListener("click", () => {
    isNightMode = !isNightMode;
    document.body.setAttribute("data-theme", isNightMode ? "night" : "day");
    document.getElementById("theme-icon").innerText = isNightMode ? "‚òÄ" : "‚òæ";
});
document.getElementById("btn-reset").addEventListener("click", resetView);
window.addEventListener("resize", () => { width=window.innerWidth; height=window.innerHeight; svg.attr("viewBox",[0,0,width,height]); });
</script>
</body>
</html>